name: Build and Test

# Trigger on all pushes and pull_requests to master and AssignmentX
on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - 'master'
      - 'Assignment*'

jobs:
  # Normal build + test
  build_and_test:
    name: Normal build and test
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the repository (This copies the repo into the virtual machine)
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Cache APT packages to speed up installs.
      # This caches downloaded .deb packages in ./apt-cache inside the workspace.
      # On a cache hit, apt-get can reuse them instead of downloading again.
      - name: Cache APT packages
        id: cache-apt
        uses: actions/cache@v4
        with:
          path: apt-cache
          key: ${{ runner.os }}-apt-${{ hashFiles('.github/workflows/*.yml') }}
          restore-keys: |
            ${{ runner.os }}-apt-

      # Step 3: Ensure APT cache directory exists for use with Dir::Cache::Archives
      - name: Prepare APT cache directory
        run: mkdir -p apt-cache/partial

      # additional step to avoid lengthy unnecessary task
      - name: Disable man-db to speed up installs
        run: |
          sudo apt-get -y remove man-db || true
          sudo apt-get -y purge man-db || true
          sudo apt-get -y autoremove || true

      # Step 4: Install necessary tools using cached APT packages
      # This uses ./apt-cache as the apt archive directory (where .deb files are stored).
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get -o Dir::Cache::Archives=$PWD/apt-cache install -y \
            --no-install-recommends cmake build-essential doxygen libvtk9-dev

      # Step 5: Fix APT cache permissions and remove lock file so cache can be saved
      # Without this, root-owned lock files can break `actions/cache` on save.
      - name: Normalize APT cache permissions
        run: |
          sudo rm -f apt-cache/lock || true
          sudo chmod -R a+rX apt-cache || true

      # Step 6: Cache CMake configuration (result of `cmake -S . -B build`)
      # This avoids redoing configure work if CMake files haven't changed.
      - name: Cache CMake configuration
        uses: actions/cache@v4
        with:
          path: |
            build/CMakeCache.txt
            build/CMakeFiles
          key: ${{ runner.os }}-cmake-${{ hashFiles('CMakeLists.txt', 'cmake/**/*.cmake') }}
          restore-keys: |
            ${{ runner.os }}-cmake-

      # Step 7: Cache external dependencies (e.g. FetchContent, GTest) if present
      # Safe even if build/_deps doesn't exist yet; then nothing is cached.
      - name: Cache external dependencies
        uses: actions/cache@v4
        with:
          path: build/_deps
          key: ${{ runner.os }}-deps-${{ hashFiles('CMakeLists.txt', 'cmake/**/*.cmake') }}
          restore-keys: |
            ${{ runner.os }}-deps-

      # Install clang-format 21 to match local development environment
      - name: Install clang-format 21
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format-21
          sudo ln -sf /usr/bin/clang-format-21 /usr/bin/clang-format

      # Step 8: Configure CMake (needed to generate build system)
      - name: Configure project
        run: cmake -S . -B build

      # Step 9: Build with generated buildsystem using all available cores
      - name: Build project
        run: cmake --build build -- -j"$(nproc)"

      # Step 10: Build the documentation (doc_doxygen target comes from your CMake module)
      - name: Build documentation
        run: cmake --build build --target doc_doxygen

      # Step 11: Run unit tests
      - name: Run unit tests
        run: ctest --test-dir build --output-on-failure -j"$(nproc)"

  # ASan build + test (separate job, fresh build tree)
  build_and_test_asan:
    name: AddressSanitizer build and test
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # additional step
      - name: Install reviewdog
        uses: reviewdog/action-setup@v1
        with:
          reviewdog_version: latest

      # Step 2: Reuse the same APT cache as the normal build job
      - name: Cache APT packages
        id: cache-apt-asan
        uses: actions/cache@v4
        with:
          path: apt-cache
          key: ${{ runner.os }}-apt-${{ hashFiles('.github/workflows/*.yml') }}
          restore-keys: |
            ${{ runner.os }}-apt-

      # Step 3: Ensure APT cache directory exists
      - name: Prepare APT cache directory
        run: mkdir -p apt-cache/partial

      # additional step to avoid lengthy unnecessary task
      - name: Disable man-db to speed up installs
        run: |
          sudo apt-get -y remove man-db || true
          sudo apt-get -y purge man-db || true
          sudo apt-get -y autoremove || true

      # Step 4: Install ASan build dependencies using the cached APT archive
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get -o Dir::Cache::Archives=$PWD/apt-cache install -y \
            --no-install-recommends cmake build-essential libvtk9-dev

      # Step 5: Normalize APT cache permissions
      - name: Normalize APT cache permissions
        run: |
          sudo rm -f apt-cache/lock || true
          sudo chmod -R a+rX apt-cache || true

      # Note: No CMake/dep cache here on purpose to keep ASan build clean & independent.

      # Step 6: Configure CMake for ASan build (separate build directory)
      - name: Configure ASan build
        run: |
          cmake -S . -B build_asan \
                -DCMAKE_BUILD_TYPE=Debug \
                -DCMAKE_C_FLAGS="-fsanitize=address -O1 -fno-omit-frame-pointer -g" \
                -DCMAKE_CXX_FLAGS="-fsanitize=address -O1 -fno-omit-frame-pointer -g"

      # Step 7: Build with generated buildsystem using all available cores
      - name: Build ASan project
        run: cmake --build build_asan -- -j"$(nproc)"

      # Step 8: Run tests with asan build
      - name: Run ASan tests
        run: ctest --test-dir build_asan --output-on-failure -j"$(nproc)"
